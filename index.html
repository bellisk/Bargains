<!DOCTYPE html>

<html>
    <head>
        <title>Bargains</title>
    </head>
    <body style="background: #333333;">
        <canvas width="800" height="600" id="gameCanvas"></canvas>
<script src="jQuery.js"></script>
<script type="text/javascript">
const FRAMERATE = 60;
const SPF = 1.0 / FRAMERATE;
const NORTH = 0;
const SOUTH = 1;
const WEST  = 2;
const EAST  = 3;

var tileTypes = {};
tileTypes.stoneFloor = {
    name: "stoneFloor",
    sx: 0,
    sy: 0,
    wall: false
};

tileTypes.stoneWall = {
    name: "stoneWall",
    sx: 1,
    sy: 0,
    wall: true
};

var creatureTypes = {};

creatureTypes.player = {
    name: "player",
    sx: 3,
    sy: 0,
    speed: 4 * SPF
};

var currentLevel = {
    map: [],
    player: {
        type: creatureTypes.player,
        direction: SOUTH,
        x: 3,
        y: 3
    }
};

var scrollX = 0;
var scrollY = 0;

for (var y = 0; y < 100; y++) {
    var row = [];
    for (var x = 0; x < 100; x++) {
        row.push({
            type: (y % 8 == 0 || x % 8 == 0) && !((y + 2) % 8 == 0 || (x + 2) % 8 == 0) ? tileTypes.stoneWall : tileTypes.stoneFloor
        });
    }
    currentLevel.map.push(row);
}

const GRID_SIZE = 16;
const GRID_HEIGHT = 8;
const SCALE = 4;
var canvas = document.getElementById("gameCanvas");
var buffer = document.createElement("canvas");
buffer.width = canvas.width / SCALE;
buffer.height = canvas.height / SCALE;
var canvasContext = canvas.getContext("2d");
canvasContext.imageSmoothingEnabled = false;
var c = buffer.getContext("2d");
var keys = {};
var graphicsImage = new Image();
graphicsImage.src = "graphicsImage.png";

var fps = "?";
var msBuffer = [];

function tileAt(x, y) {
    return currentLevel.map[Math.floor(y)][Math.floor(x)];
}

function moveCreature(creature, dx, dy) {
    if (dx > 0) {
        var newX = creature.x + dx;
        var rectRight = newX + 0.75;
        var rectTop = creature.y + 0.75;
        var rectBottom = creature.y + 1.25;
        if (tileAt(rectRight, rectTop).type.wall || tileAt(rectRight, rectBottom).type.wall) {
            creature.x = Math.floor(rectRight) - 0.76;
        } else {
            creature.x = newX;
        }
        creature.direction = WEST;
    }
    
    if (dx < 0) {
        var newX = creature.x + dx;
        var rectLeft = newX + 0.25;
        var rectTop = creature.y + 0.75;
        var rectBottom = creature.y + 1.25;
        if (tileAt(rectLeft, rectTop).type.wall || tileAt(rectLeft, rectBottom).type.wall) {
            creature.x = Math.floor(rectLeft) + 0.76;
        } else {
            creature.x = newX;
        }
        creature.direction = EAST;
    }
    
    if (dy > 0) {
        var newY = creature.y + dy;
        var rectBottom = newY + 1.25;
        var rectLeft = creature.x + 0.25;
        var rectRight = creature.x + 0.75;
        if (tileAt(rectLeft, rectBottom).type.wall || tileAt(rectRight, rectBottom).type.wall) {
            creature.y = Math.floor(rectBottom) - 1.26;
        } else {
            creature.y = newY;
        }
        creature.direction = SOUTH;
    }
    
    if (dy < 0) {
        var newY = creature.y + dy;
        var rectTop = newY + 0.75;
        var rectLeft = creature.x + 0.25;
        var rectRight = creature.x + 0.75;
        if (tileAt(rectLeft, rectTop).type.wall || tileAt(rectRight, rectTop).type.wall) {
            creature.y = Math.floor(rectTop) + 0.26;
        } else {
            creature.y = newY;
        }
        creature.direction = NORTH;
    }
}

function update(ms) {
    msBuffer.push(ms);
    if (msBuffer.length > 10) {
        msBuffer.shift();
    }
    fps = Math.round(1000 / (msBuffer.reduce(function(a, b) { return a + b; }, 0.0) / msBuffer.length));
    
    var time = ms * FRAMERATE / 1000;
    
    if (keyDown("W")) { moveCreature(currentLevel.player, 0, -currentLevel.player.type.speed * time); }
    if (keyDown("A")) { moveCreature(currentLevel.player, -currentLevel.player.type.speed * time, 0); }
    if (keyDown("S")) { moveCreature(currentLevel.player, 0, currentLevel.player.type.speed * time); }
    if (keyDown("D")) { moveCreature(currentLevel.player, currentLevel.player.type.speed * time, 0); }
    
    scrollX = -currentLevel.player.x * GRID_SIZE + buffer.width / 2 - GRID_SIZE / 2;
    scrollY = -currentLevel.player.y * GRID_HEIGHT + buffer.height / 2 - GRID_HEIGHT / 2;
}

function drawCreature(creature) {
    gblit(creature.type.sx + creature.direction, creature.type.sy, creature.x * GRID_SIZE + scrollX, creature.y * GRID_HEIGHT + scrollY);
}

function draw() {
    c.fillStyle = "black";
    c.fillRect(0, 0, 800, 600);
    for (var y = 0; y < currentLevel.map.length; y++) {
        for (var x = 0; x < currentLevel.map[y].length; x++) {
            if (!currentLevel.map[y][x].type.wall) {
                gblit(currentLevel.map[y][x].type.sx, currentLevel.map[y][x].type.sy, x * GRID_SIZE + scrollX, y * GRID_HEIGHT + scrollY - GRID_SIZE + GRID_HEIGHT);
            }
        }
    }
    
    drawCreature(currentLevel.player);
    
    for (var y = 0; y < currentLevel.map.length; y++) {
        for (var x = 0; x < currentLevel.map[y].length; x++) {
            if (currentLevel.map[y][x].type.wall) {
                gblit(currentLevel.map[y][x].type.sx, currentLevel.map[y][x].type.sy, x * GRID_SIZE + scrollX, y * GRID_HEIGHT + scrollY - GRID_SIZE + GRID_HEIGHT);
            }
        }
    }
    
    c.fillStyle = "white";
    c.fillText(fps, 10, 10);
}

function canvasKeyDown(e) {
    keys[String.fromCharCode(e.which)] = true;
}

function canvasKeyUp(e) {
    keys[String.fromCharCode(e.which)] = false;
}

$('body').keydown(canvasKeyDown);
$('body').keyup(canvasKeyUp);

function keyDown(key) {
    return !!keys[key];
}

function blit(img, sx, sy, sw, sh, dx, dy, dw, dh) {
    if (dx > buffer.width || dy > buffer.height || dx + dw < 0 || dy + dh < 0) { return; }
    c.drawImage(img, sx, sy, sw, sh, Math.floor(dx), Math.floor(dy), dw, dh);
}

function gblit(sx, sy, dx, dy) {
    blit(graphicsImage, sx * (GRID_SIZE + 1), sy * (GRID_SIZE + 1), GRID_SIZE, GRID_SIZE, dx, dy, GRID_SIZE, GRID_SIZE);
}

var lastUpdate = new Date().getTime();

setInterval(function() {
    var currentTime = new Date().getTime();
    update(currentTime - lastUpdate);
    draw();
    canvasContext.drawImage(buffer, 0, 0, 800, 600);
    lastUpdate = currentTime;
}, 1000.0 * SPF);
</script>
    </body>
</html
